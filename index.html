<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canteen JMT</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem;}
        .main-card {background-color: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 500px; width: 100%; overflow: hidden; text-align: center; padding: 2.5rem;}
        .card-title {font-weight: 700; color: #333; font-size: 1.75rem;}
        #step-2-scan-qr, #step-3-success-display {display: none;}
        .employee-info {background-color: #e9f5ff; color: #0366d6; padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; font-size: 1.1rem;}
        #qr-reader {width:100%; border-radius: 10px; border: 1px solid #ddd;}
        .status-success {color: #28a745; border: 3px solid #28a745; border-radius: 15px; padding: 2rem; animation: pop-in 0.5s ease-out;}
        .status-success .icon {font-size: 5rem; margin-bottom: 1rem;}
        .status-success h3 {font-weight: 700;}
        .status-success .datetime {background-color: #eaf6ec; font-size: 1.1rem; padding: 0.75rem; border-radius: 10px; margin-top: 1rem; text-align: left;}
        .status-success p, .status-success .datetime {color: #555555;}
        @keyframes pop-in { 0% {transform: scale(0.5); opacity: 0;} 100% {transform: scale(1); opacity: 1;} }
    </style>
</head>
<body>
    <div class="main-card">
        <img src="https://img5.pic.in.th/file/secure-sv1/-1920-x-300-px.png" alt="Company Logo" style="max-width: 250px; margin-bottom: 2rem;">
        <div id="step-1-employee-id">
            <h3 class="card-title mb-3">กรอกรหัสพนักงาน</h3>
            <div class="input-group mb-3">
                <div class="input-group-prepend"><span class="input-group-text"><i class="fa-solid fa-id-card-clip"></i></span></div>
                <input type="text" class="form-control form-control-lg" id="IdEmployee" placeholder="กรอกรหัสพนักงาน" required>
            </div>
            <button id="checkIdBtn" class="btn btn-primary btn-lg w-100 mt-3">ตรวจสอบข้อมูล</button>
        </div>
        <div id="step-2-scan-qr">
            <h3 class="card-title mb-3">สแกน QR Code ร้านค้า</h3>
            <div class="employee-info"><strong id="displayNameScan"></strong> (<small id="displayIdScan"></small>)</div>
            <div id="qr-reader"></div>
            <button id="cancelScanBtn" class="btn btn-secondary w-100 mt-3">ยกเลิก</button>
        </div>
        <div id="step-3-success-display">
            <div class="status-success">
                <div class="icon"><i class="fas fa-check-circle"></i></div>
                <h3>บันทึกสำเร็จ</h3>
                <p class="lead mb-0">คุณ <strong id="displayNameSuccess"></strong></p>
                <p>ได้ทำรายการเรียบร้อยแล้ว</p>
                <div class="datetime">
                    <i class="fas fa-store"></i>&nbsp; ร้านค้า: <strong id="displayShopIdSuccess"></strong><br>
                    <i class="fas fa-calendar-alt"></i>&nbsp; วันที่: <span id="displayDate"></span><br>
                    <i class="fas fa-clock"></i>&nbsp; เวลา: <span id="displayTime"></span>
                </div>
            </div>
            <button id="resetBtn" class="btn btn-primary w-100 mt-4">ทำรายการใหม่</button>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbx2sbtqDmy-Ifq6lURP40wSpy1Ol7xi0Ae99BcV-PPmtPThqQNe6TS7cpNhR-ho16_p2Q/exec';
    
    // --- DOM Elements และ State Variables เหมือนเดิม ---
    const step1Div=document.getElementById("step-1-employee-id"),step2Div=document.getElementById("step-2-scan-qr"),step3Div=document.getElementById("step-3-success-display"),employeeIdInput=document.getElementById("IdEmployee"),checkIdBtn=document.getElementById("checkIdBtn"),displayNameScan=document.getElementById("displayNameScan"),displayIdScan=document.getElementById("displayIdScan"),cancelScanBtn=document.getElementById("cancelScanBtn"),displayNameSuccess=document.getElementById("displayNameSuccess"),displayDate=document.getElementById("displayDate"),displayTime=document.getElementById("displayTime"),resetBtn=document.getElementById("resetBtn"),displayShopIdSuccess=document.getElementById("displayShopIdSuccess");
    let currentEmployeeId=null,currentFullName=null,html5QrCode=null;

    // --- Event Listeners ---
    checkIdBtn.addEventListener('click', checkEmployeeId);
    cancelScanBtn.addEventListener('click', resetPage);
    resetBtn.addEventListener('click', resetPage);
    
    // --- โค้ดส่วน checkEmployeeId เหมือนเดิม ---
    function checkEmployeeId(){const e=employeeIdInput.value.trim();if(""===e)return Swal.fire("ผิดพลาด","กรุณากรอกรหัสพนักงาน","warning");showLoading("กำลังตรวจสอบ...");const t=new FormData;t.append("action","getEmployeeName"),t.append("employeeId",e),fetch(scriptURL,{method:"POST",body:t}).then(e=>e.json()).then(t=>{Swal.close(),"success"===t.result?(currentEmployeeId=e,currentFullName=t.name,displayNameScan.textContent=currentFullName,displayIdScan.textContent=`รหัส: ${currentEmployeeId}`,step1Div.style.display="none",step2Div.style.display="block",startScanner()):Swal.fire("ไม่พบข้อมูล","ไม่พบรหัสพนักงานนี้ในระบบ กรุณาตรวจสอบอีกครั้ง","error")}).catch(e=>{handleFetchError("ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้")})}

    // --- [ ปรับปรุง ] ฟังก์ชัน startScanner ---
    function startScanner() {
        html5QrCode = new Html5Qrcode("qr-reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        const successCallback = (decodedText, decodedResult) => {
            if (html5QrCode && html5QrCode.isScanning) {
                // เมื่อสแกนติด ให้หยุดกล้องก่อน แล้วค่อยส่งไปตรวจสอบ
                html5QrCode.stop().then(() => handleScanResult(decodedText));
            }
        };
        html5QrCode.start({ facingMode: "environment" }, config, successCallback)
            .catch(err => {
                Swal.fire('เกิดข้อผิดพลาดกับกล้อง', 'ไม่สามารถเริ่มการทำงานของกล้องได้ กรุณาตรวจสอบการให้สิทธิ์', 'error');
            });
    }

    // --- [ เพิ่ม ] ฟังก์ชันใหม่สำหรับตรวจสอบ QR Code ของร้านค้า ---
    function handleScanResult(shopId) {
        showLoading('กำลังตรวจสอบร้านค้า...');
        const formData = new FormData();
        formData.append('action', 'validateShop');
        formData.append('shopId', shopId);

        fetch(scriptURL, { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    // ถ้าตรวจสอบร้านค้าผ่าน ให้บันทึกข้อมูลต่อ
                    saveData(shopId);
                } else {
                    // ถ้าไม่ผ่าน ให้แจ้งเตือน และเริ่มสแกนใหม่
                    Swal.fire({
                        icon: 'error',
                        title: 'QR Code ไม่ถูกต้อง',
                        text: 'ไม่พบข้อมูลร้านค้านี้ในระบบ กรุณาลองใหม่',
                    }).then(() => {
                        startScanner(); // เริ่มการสแกนอีกครั้ง
                    });
                }
            })
            .catch(error => {
                handleFetchError('เกิดข้อผิดพลาดในการตรวจสอบร้านค้า');
            });
    }

    // --- โค้ดส่วน saveData และอื่นๆ เหมือนเดิม ---
    function saveData(e){showLoading("กำลังบันทึกข้อมูล...");const t=new FormData;t.append("action","saveScanData"),t.append("รหัสพนักงาน",currentEmployeeId),t.append("ชื่อ-สกุล",currentFullName),t.append("ID Shop",e),fetch(scriptURL,{method:"POST",body:t}).then(e=>e.json()).then(t=>{Swal.close(),"success"===t.result?showSuccessScreen(e):Swal.fire("บันทึกล้มเหลว",t.message||"Unknown server error","error")}).catch(e=>{handleFetchError(`ไม่สามารถบันทึกข้อมูลได้: ${e.message}`)})}
    function showLoading(e){Swal.fire({title:e,allowOutsideClick:!1,didOpen:()=>Swal.showLoading()})}
    function handleFetchError(e){Swal.fire("เกิดข้อผิดพลาด",e,"error"),resetPage()}
    function showSuccessScreen(e){const t=new Date,n={year:"numeric",month:"long",day:"numeric",timeZone:"Asia/Bangkok"},o={hour:"2-digit",minute:"2-digit",second:"2-digit",timeZone:"Asia/Bangkok",hour12:!1};displayNameSuccess.textContent=currentFullName,displayShopIdSuccess.textContent=e,displayDate.textContent=`${t.toLocaleDateString("th-TH",n)}`,displayTime.textContent=`${t.toLocaleTimeString("th-TH",o)} น.`,step2Div.style.display="none",step3Div.style.display="block"}
    function resetPage(){html5QrCode&&html5QrCode.isScanning&&html5QrCode.stop().catch(e=>{}),step1Div.style.display="block",step2Div.style.display="none",step3Div.style.display="none",employeeIdInput.value="",currentEmployeeId=null,currentFullName=null}
</script>

</body>
</html>
